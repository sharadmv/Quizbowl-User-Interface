package com.sharad.quizbowl.ui.client.widget;

import java.util.Arrays;
import java.util.HashMap;
import java.util.List;

import com.google.gwt.core.client.GWT;
import com.google.gwt.core.client.JsArrayInteger;
import com.google.gwt.core.client.JsArrayString;
import com.google.gwt.event.shared.GwtEvent;
import com.google.gwt.event.shared.HandlerManager;
import com.google.gwt.event.shared.HandlerRegistration;
import com.google.gwt.uibinder.client.UiBinder;
import com.google.gwt.uibinder.client.UiField;
import com.google.gwt.user.client.ui.Composite;
import com.google.gwt.user.client.ui.Widget;
import com.sharad.quizbowl.ui.client.util.JsUtil;
import com.sharad.quizbowl.ui.client.widget.event.FilterEvent;
import com.sharad.quizbowl.ui.client.widget.event.FilterEventHandler;
import com.smartgwt.client.widgets.Button;
import com.smartgwt.client.widgets.events.ClickEvent;
import com.smartgwt.client.widgets.events.ClickHandler;
import com.smartgwt.client.widgets.form.DynamicForm;
import com.smartgwt.client.widgets.form.fields.TextItem;

public class FilterBox extends Composite {
	JsArrayInteger years;
	JsArrayString tournaments, difficulties, categories;

	@UiField(provided = true)
	CheckDropBox<Integer> yearsBox;

	@UiField(provided = true)
	CheckDropBox<String> tournamentsBox, difficultiesBox, categoriesBox,
			conditionsBox;

	@UiField(provided = true)
	DynamicForm field;

	@UiField(provided = true)
	Button submit;

	HandlerManager handlerManager;
	private TextItem fieldItem;

	private static FilterBoxUiBinder uiBinder = GWT
			.create(FilterBoxUiBinder.class);

	interface FilterBoxUiBinder extends UiBinder<Widget, FilterBox> {
	}

	public FilterBox(JsArrayInteger years, JsArrayString tournaments,
			JsArrayString difficulties, JsArrayString categories) {
		this(years, tournaments, difficulties, categories, "", "Submit");
	}

	public FilterBox(JsArrayInteger years, JsArrayString tournaments,
			JsArrayString difficulties, JsArrayString categories, String title,
			String buttonTitle) {
		handlerManager = new HandlerManager(this);
		this.years = years;
		this.tournaments = tournaments;
		this.difficulties = difficulties;
		this.categories = categories;
		yearsBox = new CheckDropBox<Integer>(
				JsUtil.getListFromJs(years, "int"), "Years");
		tournamentsBox = new CheckDropBox<String>(JsUtil.getListFromJs(
				tournaments, "str"), "Tournaments");
		difficultiesBox = new CheckDropBox<String>(JsUtil.getListFromJs(
				difficulties, "str"), "Difficulties");
		categoriesBox = new CheckDropBox<String>(JsUtil.getListFromJs(
				categories, "str"), "Categories");
		conditionsBox = new CheckDropBox<String>(Arrays.asList(new String[] {
				"Answer", "Question", "All" }), "Condition", false);
		conditionsBox.setValue("Answer");
		fieldItem = new TextItem();
		fieldItem.setTitle(title);
		field = new DynamicForm();
		field.setFields(fieldItem);
		submit = new Button(buttonTitle);
		submit.addClickHandler(new ClickHandler() {

			@Override
			public void onClick(ClickEvent event) {
				HashMap<String, List<String>> parameters = new HashMap<String, List<String>>();
				parameters.put("year", yearsBox.getItems());
				parameters.put("tournament", tournamentsBox.getItems());
				parameters.put("category", categoriesBox.getItems());
				parameters.put("difficulty", difficultiesBox.getItems());
				String fieldName = "answer";
				if (conditionsBox.getItems().get(0).equals("Question"))
					fieldName = "question";
				else if (conditionsBox.getItems().get(0).equals("All"))
					parameters.put("condition",
							Arrays.asList(new String[] { "all" }));
				parameters.put(fieldName, Arrays.asList(fieldItem
						.getValueAsString() == null ? new String[] {}
						: new String[] { fieldItem.getValueAsString() }));
				FilterEvent e = new FilterEvent(parameters);
				fireEvent(e);

			}

		});
		initWidget(uiBinder.createAndBindUi(this));
	}

	@Override
	public void fireEvent(GwtEvent<?> e) {
		handlerManager.fireEvent(e);
	}

	public HandlerRegistration addFilterEventHandler(FilterEventHandler handler) {
		return handlerManager.addHandler(FilterEvent.TYPE, handler);
	}
}
